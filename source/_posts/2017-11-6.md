---
title: CSRF（Cross Site Request Forgery, 跨站域请求伪造）
date: 2017-11-06
tags: [CSRF]
categories: [web安全]
---
    1. 登录 a 网站
    2. 访问了不安全的 b 网站
    3. b 网站请求 a 的服务器接口 (携带cookie)
    4. a 服务器验证cookie ok, 数据可能被修改

## CSRF 攻击的对象

- CSRF 攻击是黑客借助受害者的 cookie 骗取服务器的信任，但是黑客并不能拿到 cookie，也看不到 cookie 的内容。

- 另外，对于服务器返回的结果，由于跨域，黑客也无法进行解析。因此，黑客无法从返回的结果中得到任何东西，他所能做的就是给服务器发送请求，以执行请求中所描述的命令，在服务器端直接改变数据的值，而非窃取服务器中的数据。

> 所以，我们要保护的对象是那些可以直接产生数据改变的服务，而对于读取数据的服务，则不需要进行 CSRF 的保护。

<!-- more -->
## 防御 CSRF 的几种策略

### 验证 HTTP Referer 字段

    - 在 HTTP 头中有一个字段叫 Referer，它记录了该 HTTP 请求的来源地址。

    - 简单易行, 但可能被篡改.

### 在请求地址中添加 token 并验证

CSRF 攻击是因为黑客可以完全伪造用户的请求，验证信息都是存在于 cookie 中，因此可以直接利用用户自己的 cookie 来通过安全验证。

抵御 CSRF，关键在于在请求中放入黑客所不能伪造的信息，并且该信息不存在于 cookie 之中。可以在 HTTP 请求中以参数的形式加入一个随机产生的 token，并在服务器端建立一个拦截器来验证这个 token.

    - token 可以在用户登陆后产生并放于 session 之中，然后在每次请求时把 token 附加到请求之后

### 在 HTTP 头中自定义属性并验证

这种方法也是使用 token 并进行验证，和上一种方法不同的是，这里并不是把 token 以参数的形式置于 HTTP 请求之中，而是把它放到 HTTP 头中自定义的属性里。

通过 XMLHttpRequest 这个类，可以一次性给所有该类请求加上 csrftoken 这个 HTTP 头属性，并把 token 值放入其中。

这样解决了上种方法在请求中加入 token 的不便，同时，通过 XMLHttpRequest 请求的地址不会被记录到浏览器的地址栏，也不用担心 token 会透过 Referer 泄露到其他网站中去。

只适用于ajax

### 其他策略

    - 只使用JSON api

    - 禁用CORS

    - 不兼容旧浏览器...