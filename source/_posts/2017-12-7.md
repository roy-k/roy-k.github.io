---
title: Nginx 常用配置
date: 2017-12-07
tags:
---
## 几个命令

    - -?, -h        帮助
    - -v, -V        版本
    - -t, -T        测试配置
    - -q            测试配置时只显示错误
    - -s            向主进程命令: stop, quit, reopen, reload
    - -p            指定nginx服务器路径前缀
    - -c            指定配置文件
    - -g            指定nginx附加配置文件路径

## 配置 (nginx.conf)

### 1. 全局块

配置运行参数: 运行nginx服务器的用户(组), 允许的进程数, 进程PID存放路径, 日志路径和类型, 配置文件引入等...

### 2. events 块

配置与用户的连接: 多进程连接的序列化, 是否允许同时接收多个连接, 事件驱动模型, 每个进程的最大连接数...

### 3. http 块

配置服务器功能: servers, 文件引入, MIME-Type, 日志, 是否使用sendfile传输文件, 连接超时, 单连接请求数上限...

### 4. sever 块

虚拟主机: locations, 监听配置, 主机名, ip配置

### 5. location 块

路由匹配: 地址定向, 数据缓存, 应答控制

```C
#user  user group;                  # 指定用户(组)可用 linux
worker_processes  1;                # 允许进程数
#pid        logs/nginx.pid;         # 进程PID 存放地址
#include file;

#error_log  logs/error.log;         # 系统运行错误日志及日志级别
#error_log  logs/error.log  notice;

events {
    # accept_mutex on;              # 默认开启, 防止多个进程对链接的争抢
    # multi_accept off;             # 默认关闭, 进程同时接收多个请求
    # use method;                   # 事件驱动模型: select, poll, kqueue, epoll...
    worker_connections  1024;       # 每个进程的最大连接数
}

http {
    include       mime.types;                   # 资源类型
    default_type  application/octet-stream;     # 字节流

    # 服务日志 remote_addr请求ip,
    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;                             # 允许sendfile方式传输文件
    keepalive_timeout  65;                          # 链接超时 [keep-alive域的超时时间]
    # tcp_nopush = on 会设置调用tcp_cork方法. 数据包不会马上传送出去，等到数据包最大时，一次性的传输出去，这样有助于解决网络堵塞。
    #tcp_nopush     on;
    #keepalive_requests number;                     # 限制用户通过单一链接请求次数

    #gzip  on;

    upstream svrs {                                 # 代理服务器组
        server 127.0.0.1:3080;
        server 127.0.0.1:3081;
    }

    server {
        listen       80;                            # 配置网络监听
        #listen      *:80;                          # 同 80
        #listen      192.168.1.10;                  # 监听具体ip 所有端口的连接
        #listen      80 default_server backlog=1024;# 设置端口为80的所有连接, 默认此虚拟主机, 允许最多1024个连接同时处于挂起状态

        server_name  localhost;                     # 约同域名, 配置好dns即可由此访问虚拟主机

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        #location [ = | ~ | ~* | ^~] uri {}         # 标识符匹配

        location /tjs {
            # root E:\\;                            # 配置根目录, 保留路径
            # alias E:\\test;                       # 更改uri, 替换路径, 即 /tjs/ -> /test/
        }

        location /tjs1 {
            proxy_pass http://svrs;                 # 转发(加上路径: tjs)
            # proxy_pass http://svrs/aa;            # 如果配置转发路径(/也算), 会替换匹配路径(tjs)
        }

        location /tjs2/ {
            # proxy_pass http://svrs/;              # 这样就可以除去路径, 即 /tjs2/svrs -> /svrs
        }

        location /others {
            #root path;
            #index file;                            # 默认首页, 可以根据不同路径, 展示不同首页
        }


        #error_page  404              /404.html;    # 错误码 对应的错误页面

        # redirect server error pages to the static page /50x.html
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

        # proxy the PHP scripts to Apache listening on 127.0.0.1:80
        #
        #location ~ \.php$ {
        #    proxy_pass   http://127.0.0.1;
        #}

        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
        #
        #location ~ \.php$ {
        #    root           html;
        #    fastcgi_pass   127.0.0.1:9000;
        #    fastcgi_index  index.php;
        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
        #    include        fastcgi_params;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #    deny  all;
        #}
    }

    server {
    #    listen       somename:8080;
        server_name  localhost;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location /api {
             proxy_pass http://api;
        }
    }

    # HTTPS server
    #
    #server {
    #    listen       443 ssl;
    #    server_name  localhost;

    #    ssl_certificate      cert.pem;
    #    ssl_certificate_key  cert.key;

    #    ssl_session_cache    shared:SSL:1m;
    #    ssl_session_timeout  5m;

    #    ssl_ciphers  HIGH:!aNULL:!MD5;
    #    ssl_prefer_server_ciphers  on;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}
}
```

## Nginx 代理服务

### 1. 正向代理: 用代理访问外网

### 2. 反向代理: 开放给外部访问

```C
upstream proxy_svrs {
    server 127.0.0.1:3080;
    server 127.0.0.1:3081 weight=2;
}

server {
    location /ttjs {
        proxy_pass http://proxy_svrs;       # 此处声明协议, upstream处就省去
        # 其他命令
    }
}
```
- proxy_pass                    设置转发目标
- proxy_hide_header             隐藏一些头域信息
- proxy_pass_header             添加部分报文头
- proxy_pass_request_body       设置是否转发请求体 默认on
- proxy_pass_request_headers    设置是否转发请求头 默认on
- proxy_set_header              更改..头
- proxy_set_body                更改..体
- proxy_bind
- proxy_connect_timeout         连接目标服务器超时
- proxy_read_timeout
- proxy_send_timeout
- proxy_http_version
- proxy_method                  转发所用方法
- proxy_ignore_client_abort     客户端中断时是否立即中断 默认on, 即中断
- proxy_ignore_headers
- proxy_redirect                设置响应头域
- proxy_intercept_errors
- proxy_headers_hash_max_size
- proxy_headers_hash_bucket_size
- proxy_next_upstream
- proxy_ssl_session_reuse


## 配置优化
[Nginx 配置陷阱和常见错误](http://www.7rack.info/Nginx-Config-Pitfalls.html)
1. root / index 提出

```C
server {
    server_name www.example.com;
    location / {
        root /var/www/nginx-default/;
        index index.php index.htm index.html;
      }
    location /foo {
        root /var/www/nginx-default/;
        index index.php index.htm index.html;
    }
}
# -->

index index.php index.htm index.html;   # http块中 将会被继承
server {
    server_name www.example.com;
    root /var/www/nginx-default/;       # 避免每个location都配一遍
    location / {
    }
    location /foo {
    }
}

```

2. 不使用 Hostname 去解析地址

```C
upstream {
    server http://someserver;
}

server {
    listen myhostname:80;
    # [...]
}
# 在服务启动或者重启时 hostname 不能解析。这会引起 NGINX 无法绑定到特定的 TCP 端口而启动失败。
upstream {
    server http://10.48.41.12;
}

server {
    listen 127.0.0.16:80;
    # [...]
}
```

...