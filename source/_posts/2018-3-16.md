---
title: travis实现自动部署git项目到私有云服务器
date: 2018-03-16
tags:
---
<div  align="center">
<img src="http://47.52.170.75/images/blog/deploy/travis20180315_1.jpg" width = "1000" alt="" align=center />
</div>

自己有一个阿里云的虚拟服务器，用来部署自己闲暇所写练习。之前没有了解到自动化部署方案，每次更新需要登录服务器来更新文件，实在麻烦。偶然看到可以[自动化部署](https://juejin.im/entry/5a7d77bcf265da4e8c44fdb6)，所以有如下一番折腾。

## 原理图
<div  align="center">
<img src="http://47.52.170.75/images/blog/deploy/travis20180315_2.jpg" width = "500" alt="" align=center />
</div>

本地开发 -> 提交github -> travis收到通知执行脚本(编译、测试等) -> travis登录服务器执行部署命令

## 说明：

实现较为个人，服务器直接使用root账户

vue静态项目，只需要部署编译后的文件即可

如需做服务器用户区分等，可查看相关文章，底部链接中即有


## 主要步骤：

1. 创建github公开项目

2. 服务器实现手动部署能力

3. 登录travis，开启项目监听

4. 服务器安装travis客户端等

5. 处理rsa秘钥，并加入项目托管

6. 测试

## 详细流程：

### 1. 创建github公开项目

没啥注意的，跑通项目就行了

### 2. 服务器实现手动部署能力

安装相关环境：git，node等相关依赖

实现：git更新项目、node构建、[nginx服务](https://github.com/roy-k/roy-k.github.io/issues/4)等，实现线上访问

[git-ssh配置和使用](https://www.google.com/search?newwindow=1&safe=strict&ei=YYarWv67HMSw0gTzoILwCQ&q=git-ssh)

进入秘钥文件夹

    cd .ssh/

将生成的公钥添加为受信列表(**travis访问服务器的关键**)

    cat id_rsa.pub >> authorized_keys

测试访问，创建config文件，内容见下

> 假如使用非root用户，需注意[权限相关](https://juejin.im/post/5a9e1a5751882555712bd8e1)

```C
Host test
HostName 99.99.99.99(你的服务器ip)
#登陆的用户名
User travis
IdentitiesOnly yes
#登陆使用的密钥
IdentityFile ~/.ssh/id_rsa
```

    ssh test

### 3. 登录travis，开启项目监听

使用github账户，登录[travis](https://travis-ci.org)

开启项目监听
<div  align="center">
<img src="http://47.52.170.75/images/blog/deploy/travis20180315_3.jpg" width = "300" alt="" align=center />
</div>
进入项目日志页，先保留页面

### 4. 服务器安装travis客户端等

需先安装 ruby2.0

    yum install ruby

    验证： ruby -v 或 gem -v

通过gem安装travis

    gem install travis

    可能会安装失败 提示缺少ruby头文件，**yum install ruby-devel**可解决

登录travis, 使用github账户

    travis login

### 5. 处理rsa秘钥，并加入项目托管

进入项目目录，创建.travis.yml文件，填写项目基本配置，例：
```javascript
language: node_js
node_js:
- '8.9.0'
```

加密本地秘钥, 会自动写入<em>.travis.yml</em>文件

    travis encrypt-file ~/.ssh/id_rsa --add

编辑<em>.travis.yml</em>文件

    删除最后一行的转义符(\)

```javascript
before_install:
    - openssl aes-256-cbc -K $encrypted_e65149523857_key -iv $encrypted_e65149523857_iv
    -in id_rsa.enc -out ~\/.ssh/id_rsa -d
```

添加after_success钩子(**部署关键**)

    原理是使用ssh连接服务器，执行部署命令

```javascript
after_success:
    - ssh root@xx.xx.xx.xx -o StrictHostKeyChecking=no 'cd 项目目录 && git pull && npm install && npm run build'
```

>使用 ssh 命令连接一定要设置StrictHostKeyChecking=no，否则第一次连接时依然会要求你确认。后面引号的内容就是登陆你的Linux服务器之后，在你的服务器执行的命令，你也可以写成一个脚本。只要登陆上服务器之后，就随你操作了。

提交上述更改至github

### 6. 测试

更新、编辑、提交

刷新查看第3步保留的项目日志页，可跟踪执行状态
<div  align="center">
<img src="http://47.52.170.75/images/blog/deploy/travis20180315_4.jpg" width = "800" alt="" align=center />
</div>

## 异常点

    - yarn-lock文件有影响自动测试，删除后ok，使用npm，故未做深究。

    - 服务器有开放StrictHostKeyChecking，还是需在ssh命令禁止验证，未知

## 未达成

    - 集成测试相关配置(travis 配置)


## 参考文章

- [不仅仅是前端er——折腾服务器武装自己](https://juejin.im/entry/5a7d77bcf265da4e8c44fdb6)
- [Travis-CI自动化测试并部署至自己的CentOS服务器](https://juejin.im/post/5a9e1a5751882555712bd8e1)
- [gem install：无法构建gem原生扩展（无法找到头文件）](http://bbs.bugcode.cn/t/5665)
 [linux ssh_config和sshd_config配置文件](https://www.cnblogs.com/ilinuxer/p/5087452.html)
- [SSH连接时提示“THE AUTHENTICITY OF HOST XX CAN’T BE ESTABLISHED”](http://smilejay.com/2012/12/ssh-config-host-key-checking/)
- 等等